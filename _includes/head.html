<!-- Jekyll Head Template - 优化版本 -->
<head>
  <!-- ========== 基础元数据 ========== -->
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="msvalidate.01" content="6FB18D3E0FC9068EDA29796251B1E253" />
  
  <!-- 主题颜色 -->
  <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7" />
  <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e" />

  <!-- SEO相关 -->
  {% if page.post %}
  <meta name="keywords" content="{{ page.keywords }}" />
  <meta name="author" content="{{ page.author }}" />
  {% else %}
  <meta name="keywords" content="{{ site.keywords }}" />
  <meta name="author" content="{{ site.author }}" />
  {% endif %}

  <!-- ========== 核心功能脚本 ========== -->
  <!-- 浏览器信息检测 -->
  <script src="https://{{site.js_cdn1}}/npm/browser-tool@1.3.1/dist/browser.min.js" 
          integrity="sha256-UPj46Hf28kziVvYS7tWGvZy9COcV7hKW+KqOyqYzkeI=" 
          crossorigin="anonymous"></script>

  <!-- 主题模式切换 -->
  {% unless site.theme_mode %}
  {% include mode-toggle.html %}
  {% endunless %}

  <!-- 核心includes -->
  {% include embed/lookup.html %}
  {% include embed/pan.html %}
  {% include embed/testOS.html %}

  <!-- 核心工具库 -->
  {% include head/maintool.html %}

  <!-- 字体资源 -->
  {% include head/mainfont.html %}

  <!-- ========== 通用工具库 ========== -->
  <!-- CDN动态加载工具 -->
  <script>
    window.appendJQCDN = (src) => {
      var head = document.head || document.getElementsByTagName("head")[0];
      if (src.endsWith(".css")) {
        var style = document.createElement("LINK");
        style.setAttribute("type", "text/css");
        style.setAttribute("rel", "stylesheet");
        style.setAttribute("href", src);
        head.appendChild(style);
      } else if (src.endsWith(".js")) {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.setAttribute("src", src);
        head.appendChild(script);
      }
    };

    window.isAppendCDN = (err) => {
      if (sessionStorage.getItem("isPan") == "false") {
        appendJQCDN(err);
      }
    };
  </script>

  <!-- 加载动画控制 -->
  <script>
    window.load_event = {
      load_anime: () => {
        const loads = document.getElementById("loading-gif-box");
        loads.style.opacity = "0";
        loads.style.zIndex = "-999999";
      },
    };
  </script>

  <!-- ========== 主题和模式控制 ========== -->
   <!-- 主题模式设置 -->
  <script>
    let box = document.documentElement;
    if (!box.getAttribute("data-mode")) {
      if (modeToggle.modeStatus == "dark") {
        box.setAttribute("data-mode", "dark");
      } else {
        box.setAttribute("data-mode", "light");
      }
    }
  </script>
  <!-- 加载动画样式 -->
  <script>
    const style = document.createElement("style");
    style.type = "text/css";

    if (modeToggle.modeStatus == "dark") {
      style.innerHTML = "#loading-gif-box{background-color: #000;} .loading-boxs-imgs{background-image: url(https://source.rainsin.cn/img/darkload.gif?sign=HSMBFJIuwRnWabf8E1WJKYaTOneSVDmMdmfOphPDbdw=:0);}";
    } else {
      style.innerHTML = "#loading-gif-box{background-color: #fff;} .loading-boxs-imgs{background-image: url(https://source.rainsin.cn/img/loadlight.gif?sign=FJgpddP5fi4a60y3yWNyJ6chvzOREupwOfPWk03U_ik=:0);}";
    }
    document.getElementsByTagName("head")[0].appendChild(style);
  </script>

  <!-- ========== 评论系统 ========== -->
  {% if page.comments %}
  <script src="https://cdn.rainsin.cn/Artalk@2.9.1/Artalk.min.js"></script>
  <script>

        const ArtalkMusicPlugin = (ctx) => {
            const { $root, conf } = ctx;

      
            const pluginConf = {
                supportedFormats: ['.mp3', '.flac', '.wav', '.ogg', '.m4a', '.aac'],
                style: {
                    backgroundColor: '#f8f9fa',
                    borderColor: '#e9ecef',
                    primaryColor: '#007bff',
                    textColor: '#495057'
                }
            };

     
            const createMusicPlayer = (src, title = '') => {
                if (!title) {
                    const urlParts = decodeURIComponent(src).split('/');
                    title = urlParts[urlParts.length - 1].replace(/\.[^/.]+$/, "");
                }

                const playerId = 'music-player-' + Math.random().toString(36).substr(2, 9);
                
                return `
                    <div class="artalk-music-player" data-src="${src}">
                        <div class="music-player-container">
                            <div class="music-info">
                                <div class="music-title">${title}</div>
                                <div class="music-time">
                                    <span class="current-time">00:00</span>
                                    <span class="separator">/</span>
                                    <span class="duration">00:00</span>
                                </div>
                            </div>
                            <div class="music-controls">
                                <button class="play-btn" data-player-id="${playerId}">
                                    <svg class="play-icon" viewBox="0 0 24 24" width="16" height="16">
                                        <path fill="currentColor" d="M8 5v14l11-7z"/>
                                    </svg>
                                    <svg class="pause-icon" viewBox="0 0 24 24" width="16" height="16" style="display: none;">
                                        <path fill="currentColor" d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                    </svg>
                                </button>
                                <div class="progress-container">
                                    <div class="progress-bar">
                                        <div class="progress-fill"></div>
                                        <div class="progress-handle"></div>
                                    </div>
                                </div>
                                <button class="volume-btn">
                                    <svg viewBox="0 0 24 24" width="16" height="16">
                                        <path fill="currentColor" d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                                    </svg>
                                </button>
                            </div>
                            <audio id="${playerId}" preload="metadata" crossorigin="anonymous">
                                <source src="${src}">
                                您的浏览器不支持音频播放。
                            </audio>
                        </div>
                    </div>
                `;
            };


            const addStyles = () => {
                const styleId = 'artalk-music-player-styles';
                if (document.getElementById(styleId)) return;

                const style = document.createElement('style');
                style.id = styleId;
                style.textContent = `
                    .artalk-music-player {
                        margin: 12px 0;
                        padding: 16px;
                        background: ${pluginConf.style.backgroundColor};
                        border: 1px solid ${pluginConf.style.borderColor};
                        border-radius: 8px;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        transition: all 0.2s ease;
                    }

                    .artalk-music-player:hover {
                        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    }

                    .music-player-container {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    }

                    .music-info {
                        flex: 1;
                        min-width: 0;
                    }

                    .music-title {
                        font-size: 14px;
                        font-weight: 500;
                        color: ${pluginConf.style.textColor};
                        margin-bottom: 4px;
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                    }

                    .music-time {
                        font-size: 12px;
                        color: #6c757d;
                    }

                    .music-controls {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        flex-shrink: 0;
                    }

                    .play-btn, .volume-btn {
                        background: none;
                        border: none;
                        cursor: pointer;
                        padding: 8px;
                        border-radius: 4px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: ${pluginConf.style.primaryColor};
                        transition: all 0.2s ease;
                    }

                    .play-btn:hover, .volume-btn:hover {
                        background: rgba(0, 123, 255, 0.1);
                    }

                    .progress-container {
                        flex: 1;
                        min-width: 100px;
                        max-width: 200px;
                    }

                    .progress-bar {
                        position: relative;
                        height: 4px;
                        background: #e9ecef;
                        border-radius: 2px;
                        cursor: pointer;
                        transition: height 0.2s ease;
                    }

                    .progress-bar:hover {
                        height: 6px;
                    }

                    .progress-fill {
                        height: 100%;
                        background: ${pluginConf.style.primaryColor};
                        border-radius: 2px;
                        width: 0%;
                        transition: width 0.1s ease;
                    }

                    .progress-handle {
                        position: absolute;
                        top: 50%;
                        transform: translate(-50%, -50%);
                        width: 12px;
                        height: 12px;
                        background: ${pluginConf.style.primaryColor};
                        border-radius: 50%;
                        opacity: 0;
                        transition: opacity 0.2s ease;
                        left: 0%;
                    }

                    .progress-bar:hover .progress-handle {
                        opacity: 1;
                    }

                    .artalk-music-error {
                        color: #dc3545;
                        background: #f8d7da;
                        border: 1px solid #f5c6cb;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 14px;
                        margin: 8px 0;
                    }

                    @media (max-width: 480px) {
                        .music-player-container {
                            flex-direction: column;
                            align-items: stretch;
                            gap: 8px;
                        }

                        .music-controls {
                            justify-content: center;
                        }

                        .progress-container {
                            max-width: none;
                        }
                    }
                `;
                document.head.appendChild(style);
            };

     
            const formatTime = (seconds) => {
                if (!seconds || isNaN(seconds)) return '00:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
            };

     
            const initAudioPlayer = (playerElement) => {
                const audio = playerElement.querySelector('audio');
                const playBtn = playerElement.querySelector('.play-btn');
                const playIcon = playerElement.querySelector('.play-icon');
                const pauseIcon = playerElement.querySelector('.pause-icon');
                const progressBar = playerElement.querySelector('.progress-bar');
                const progressFill = playerElement.querySelector('.progress-fill');
                const progressHandle = playerElement.querySelector('.progress-handle');
                const currentTimeEl = playerElement.querySelector('.current-time');
                const durationEl = playerElement.querySelector('.duration');

                let isDragging = false;

    
                playBtn.addEventListener('click', () => {
                    if (audio.paused) {
       
                        document.querySelectorAll('.artalk-music-player audio').forEach(otherAudio => {
                            if (otherAudio !== audio && !otherAudio.paused) {
                                otherAudio.pause();
                                const otherPlayer = otherAudio.closest('.artalk-music-player');
                                const otherPlayIcon = otherPlayer.querySelector('.play-icon');
                                const otherPauseIcon = otherPlayer.querySelector('.pause-icon');
                                otherPlayIcon.style.display = 'block';
                                otherPauseIcon.style.display = 'none';
                            }
                        });

                        audio.play().catch(e => console.log('播放失败:', e));
                        playIcon.style.display = 'none';
                        pauseIcon.style.display = 'block';
                    } else {
                        audio.pause();
                        playIcon.style.display = 'block';
                        pauseIcon.style.display = 'none';
                    }
                });

          
                audio.addEventListener('loadedmetadata', () => {
                    durationEl.textContent = formatTime(audio.duration);
                });

            
                audio.addEventListener('timeupdate', () => {
                    if (!isDragging && audio.duration) {
                        const progress = (audio.currentTime / audio.duration) * 100;
                        progressFill.style.width = progress + '%';
                        progressHandle.style.left = progress + '%';
                        currentTimeEl.textContent = formatTime(audio.currentTime);
                    }
                });

             
                audio.addEventListener('ended', () => {
                    playIcon.style.display = 'block';
                    pauseIcon.style.display = 'none';
                    progressFill.style.width = '0%';
                    progressHandle.style.left = '0%';
                    currentTimeEl.textContent = '00:00';
                });

            
                audio.addEventListener('error', (e) => {
                    console.error('音频加载错误:', e);
                    playerElement.innerHTML = '<div class="artalk-music-error">音频加载失败，请检查链接是否有效</div>';
                });

             
                const updateProgress = (e) => {
                    const rect = progressBar.getBoundingClientRect();
                    const percent = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
                    const newTime = percent * audio.duration;
                    
                    if (!isNaN(newTime) && audio.duration) {
                        audio.currentTime = newTime;
                        const progress = percent * 100;
                        progressFill.style.width = progress + '%';
                        progressHandle.style.left = progress + '%';
                        currentTimeEl.textContent = formatTime(newTime);
                    }
                };

                progressBar.addEventListener('mousedown', (e) => {
                    isDragging = true;
                    updateProgress(e);
                });

                document.addEventListener('mousemove', (e) => {
                    if (isDragging) {
                        updateProgress(e);
                    }
                });

                document.addEventListener('mouseup', () => {
                    isDragging = false;
                });

                progressBar.addEventListener('click', updateProgress);
            };

   
            const parseMusicSyntax = (content) => {
                const musicRegex = /\(music\)\[src="([^"]+)"(?:\s+title="([^"]*)")?\]/g;
                
                return content.replace(musicRegex, (match, src, title) => {
                    const isSupported = pluginConf.supportedFormats.some(format => 
                        src.toLowerCase().includes(format)
                    );
                    
                    if (!isSupported) {
                        return `<div class="artalk-music-error">不支持的音频格式: ${src}</div>`;
                    }
                    
                    return createMusicPlayer(src, title);
                });
            };


            const processExistingContent = () => {
                const elements = $root.querySelectorAll('.atk-comment-content, .atk-preview');
                elements.forEach(el => {
                    if (el.innerHTML.includes('(music)')) {
                        el.innerHTML = parseMusicSyntax(el.innerHTML);

                        el.querySelectorAll('.artalk-music-player').forEach(initAudioPlayer);
                    }
                });
            };

     
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    mutation.addedNodes.forEach((node) => {
                        if (node.nodeType === 1) {
         
                            if (node.classList && (node.classList.contains('atk-comment-content') || node.classList.contains('atk-preview'))) {
                                if (node.innerHTML.includes('(music)')) {
                                    node.innerHTML = parseMusicSyntax(node.innerHTML);
                                    node.querySelectorAll('.artalk-music-player').forEach(initAudioPlayer);
                                }
                            }
                            
         
                            const contentElements = node.querySelectorAll ? node.querySelectorAll('.atk-comment-content, .atk-preview') : [];
                            contentElements.forEach(el => {
                                if (el.innerHTML.includes('(music)')) {
                                    el.innerHTML = parseMusicSyntax(el.innerHTML);
                                    el.querySelectorAll('.artalk-music-player').forEach(initAudioPlayer);
                                }
                            });
                            
                      
                            const musicPlayers = node.querySelectorAll ? node.querySelectorAll('.artalk-music-player') : [];
                            musicPlayers.forEach(initAudioPlayer);
                            
                            if (node.classList && node.classList.contains('artalk-music-player')) {
                                initAudioPlayer(node);
                            }
                        }
                    });
                });
            });


            const init = () => {
                addStyles();
                observer.observe($root, {
                    childList: true,
                    subtree: true
                });
                
      
                setTimeout(processExistingContent, 100);
            };

            const destroy = () => {
                observer.disconnect();
            };

            return {
                name: 'ArtalkMusicPlugin',
                init,
                destroy
            };
        };

    window.load_event = {
      ...window.load_event,
      comments: () => {
        const artalk = Artalk.use(ArtalkMusicPlugin).init({
          el: '#tcomment',
          server: 'https://waline.cpolar.cn',
          darkMode: document.documentElement.dataset.mode == "dark",
          site: 'Rainsin\'s Blog'
        });
        document.getElementsByClassName("atk-copyright")[0] ? document.getElementsByClassName("atk-copyright")[0].style.display = "none" : ""; 
        window.mode_change = {
          ...window.mode_change,
          artalk_mode: () => {
            artalk.update({
              el: '#tcomment',
              server: 'https://waline.cpolar.cn',
              darkMode: document.documentElement.dataset.mode == "dark",
              site: 'Rainsin\'s Blog'
            });
            document.getElementsByClassName("atk-copyright")[0] ? document.getElementsByClassName("atk-copyright")[0].style.display = "none" : ""; 
          }
        }
      }
    };
  </script>
  {% endif %}

  <!-- ========== 主要样式表 ========== -->
  <!-- 自定义样式 -->
  <link rel="stylesheet" href="https://source.rainsin.cn/assets/css/comments-min.css" />
  <link rel="stylesheet" href="https://source.rainsin.cn/assets/css/root-min.css" />
  <link rel="stylesheet" href="https://source.rainsin.cn/assets/css/card-profile.css" />
  <link href="https://source.rainsin.cn/assets/css/font.css" rel="stylesheet" />
  <link href="https://source.rainsin.cn/assets/css/em.css" rel="stylesheet" />

  <!-- 通用样式修正 -->
  <style>
    .footnotes>ol>li>p,
    .charch-indent blockquote p {
      text-indent: 0;
    }
  </style>

  <!-- Bootstrap和主题样式 -->
  {% if site.resources.ignore_env != jekyll.environment and site.resources.self_hosted %}
  <link href="{{ site.data.origin[type].webfonts | relative_url }}" rel="stylesheet" />
  {% else %}
  {% for cdn in site.data.origin[type].cdns %}
  <link rel="preconnect" href="{{ cdn.url }}" {{ cdn.args }} />
  <link rel="dns-prefetch" href="{{ cdn.url }}" {{ cdn.args }} />
  {% endfor %}
  <link rel="stylesheet" href="{{ site.data.origin[type].webfonts | relative_url }}" />
  {% endif %}

  <link rel="stylesheet" href="{{ site.data.origin[type].bootstrap.css | relative_url}}" />
  <link rel="stylesheet" href="{{ site.data.origin[type].fontawesome.css | relative_url }}" />
  <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}" />

  {% if site.toc and page.toc %}
  <link rel="stylesheet" href="{{ site.data.origin[type].toc.css | relative_url }}" />
  {% endif %}

  {% if page.layout == 'page' or page.layout == 'post' %}
  <link rel="stylesheet" href="{{ site.data.origin[type].magnific-popup.css | relative_url }}" />
  {% endif %}

  <!-- ========== SEO和页面信息 ========== -->
  {% capture seo_tags %}
    {% seo title=false %}
  {% endcapture %}

  {% if page.image %}
  {% assign img = page.image.path | default: page.image %}
  {% unless img contains '://' %}
  {% assign img_path = page.img_path | append: '/' | append: img | replace: '//', '/' %}
  {% capture target %}"{{ img | absolute_url }}"{% endcapture %}
  {% if site.img_cdn contains '//' %}
  {% capture replacement %}"{{ site.img_cdn }}{{ img_path }}"{% endcapture %}
  {% else %}
  {%- capture replacement -%}"{{ site.img_cdn | append: '/' | append: img_path | replace: '//', '/' | absolute_url }}"{%- endcapture -%}
  {% endif %}
  {% assign seo_tags = seo_tags | replace: target, replacement %}
  {% endunless %}
  {% endif %}

  {{ seo_tags }}

  <title>
    {%- unless page.layout == 'home' -%}{{ page.title | append: ' | ' }}{%- endunless -%}{{ site.title }}
  </title>

  <!-- ========== 收尾工作 ========== -->
  {% include favicons.html %}
  <script src="https://source.rainsin.cn/assets/js/ms.js"></script>
  {% include js-selector.html %}
  {% include set-mode.html %}
  {% include metadata-hook.html %}

  <!-- 开发工具 (注释掉) -->
  <!-- <script src="/assets/js/dev.js"></script> -->
</head>